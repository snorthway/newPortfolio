{% extends "base.html" %}

{% block title %}Physarum Boston Model{% endblock %}

{% block content %}
	<div id="map"></div>
{% endblock %}

{% block extrajs %}
<script src="{{ url_for('static', filename='js/d3.v3.min.js') }}"></script>
<script type="text/javascript">
//Ugly code, completely written between 8PM on Dec. 18 and 5AM on Dec 19

	d3.csv("{{ url_for('static', filename='gba_pop.csv')}}", function(csv){

		// sum varz
		var w=960, h=500;
		var zx=w*(3/5), zy=h/2;
		var scale = 750;
		var big = 1000;

		// so I don't have to type this a billion times
		function centerPlace(d, axis){
			if (axis == "x"){
				return zx + scale*d["Long diff"];
			} else if (axis == "y"){
				return zy + scale*d["Lat diff"];
			}
		}

		// make the svg element
		svg=d3.select("#map")
		.append("svg")
		.attr("width",w)
		.attr("height",h)
		.style("background-color", "white");

		// make the distance matrix as a basis for finding MST
		var distanceMatrix = []
		for (var i=0; i<csv.length; i++){
			distanceMatrix.push([]);
			c1 = csv[i]
			for (var j=0; j<csv.length; j++){
				c2 = csv[j]
				hyp = Math.sqrt(Math.pow(c1["Latitude (N)"]-c2["Latitude (N)"],2)+Math.pow(c1["Longitude (W)"]-c2["Longitude (W)"],2));
				if (hyp == 0){
					distanceMatrix[i].push(big);
				} else{
					distanceMatrix[i].push(hyp);
				}	
			}
		}

		// append the data to csv info
		for (var i=0; i<csv.length; i++){
			csv[i].dists = distanceMatrix[i];
			csv[i].connected = false;
		}
		csv.connections = []

		// find the minimum spanning tree
		function findMST(data, r){
			if (r == false){
				var indexOfMin = data[0].dists.indexOf(Math.min.apply(null, data[0].dists));
				data.connections.push([0,indexOfMin]);
				data[0].connected = true;
				data[0].dists[indexOfMin] = big;
				data[indexOfMin].connected = true;
				data[indexOfMin].dists[0] = big;

				// draw lines here because I suck
				svg.append("line")
				.style("stroke-width", 2)
				.style("stroke", "gray")
				.attr("x1",centerPlace(data[0],"x"))
				.attr("y1",centerPlace(data[0],"y"))
				.attr("x2",centerPlace(data[indexOfMin],"x"))
				.attr("y2",centerPlace(data[indexOfMin],"y"));

				// recurse!
				findMST(data, true);
			} else {
				var conNodes = data.filter(function (d){return d.connected == true});
				// console.log(conNodes.length);
				// initialize to something that will error
				var indexOfMin = -1;
				var conNodeIndex = -1;
				for (i=0;i<conNodes.length;i++){
					if (i==0){
						var conNodeMin = Math.min.apply(null, conNodes[i].dists);
						indexOfMin = conNodes[i].dists.indexOf(conNodeMin);
						conNodeIndex = i;
					} else {
						newConNodeMin = Math.min.apply(null, conNodes[i].dists);
						var newIndex = conNodes[i].dists.indexOf(newConNodeMin);
						if (newConNodeMin < conNodeMin){
							conNodeMin = newConNodeMin;
							indexOfMin = newIndex;
							conNodeIndex = i;
						}
					}
					
				}
				

				var oldNodeIndex = data.indexOf(conNodes[conNodeIndex]);
				if (conNodes.length == 15){console.log(oldNodeIndex);}
				data.connections.push([oldNodeIndex, indexOfMin]);
				data[oldNodeIndex].dists[indexOfMin] = big;
				data[indexOfMin].connected = true;
				data[indexOfMin].dists[oldNodeIndex] = big;

				data.forEach(function(entry){
					if (entry.connected == true){
						for (i=0;i<data.length;i++){
							if (data[i].connected == true){
								entry.dists[i] = big;
							}
						}
					}
				});

				// draw lines here because I suck
				svg.append("line")
				.style("stroke-width", 2)
				.style("stroke", "gray")
				.attr("x1",centerPlace(data[oldNodeIndex],"x"))
				.attr("y1",centerPlace(data[oldNodeIndex],"y"))
				.attr("x2",centerPlace(data[indexOfMin],"x"))
				.attr("y2",centerPlace(data[indexOfMin],"y"));

				if (data.every(function (d){return d.connected == true})){
					console.log(data);
					return data;
				} else {
					// console.log(data.filter(function (d){return d.connected == false}).length);
					// recurse!
					findMST(data, true);
				}
			}
		}



		// console.log(Math.min.apply(null, csv[0].dists));
		newData = findMST(csv, false);
		console.log(newData);



		// make the circles, give them csv as data
		var circles = svg.selectAll("circle")
		.data(csv)
		.enter()
		.append("circle");

		//style and position
		var circleAttributes = circles
		.style("stroke", "gray")
		.style("fill", "yellow")
		.attr("r", 5)
		.attr("cx", function (d){return centerPlace(d, "x")})
		.attr("cy", function (d){return centerPlace(d, "y")});

		// make the labels, give them csv as data
		var labels = svg.selectAll("text")
		.data(csv)
		.enter()
		.append("text");

		// style and position and text
		var labelAttributes = labels
		.style("font-size", 10)
		.attr("x", function (d){return centerPlace(d, "x")})
		.attr("y", function (d){return centerPlace(d, "y")})
		.text(function (d){return d["City"]});

		// // same shit for edges
		// var edges = svg.selectAll("line")
		// .data(newData)
		// .enter()
		// .append("line");

		// // more of the same shit
		// var edgeAttributes = edges
		// .style("stroke", "gray")
		// .style("stroke-width", 2);

	});

	
</script>
{% endblock %}